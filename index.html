<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ä¸­å­¦æ ¡æŠ€è¡“ï¼šãƒ–ãƒƒã‚¯ãƒ©ãƒƒã‚¯å¼·åº¦è¨ºæ–­ã‚¢ãƒ—ãƒª</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; }
    #sidebar { width: 350px; padding: 20px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
    #canvas-container { flex: 1; position: relative; background: #222; }
    h1 { font-size: 18px; color: #333; }
    .card { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
    label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #555; }
    input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: #0056b3; }
    button.secondary { background: #6c757d; }
    .status-ok { color: #28a745; font-weight: bold; }
    .status-ng { color: #dc3545; font-weight: bold; }
    .legend { display: flex; align-items: center; margin-top: 10px; font-size: 12px; }
    .bar { flex: 1; height: 10px; background: linear-gradient(to right, blue, yellow, red); margin: 0 10px; border-radius: 5px; }
  </style>
</head>
<body>

<div id="sidebar">
  <h1>ğŸ› ï¸ å¼·åº¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
  
  <div class="card">
    <label>1. è¨­è¨ˆå›³(STL)ã‚’èª­ã¿è¾¼ã‚€</label>
    <input type="file" id="fileInput" accept=".stl">
  </div>

  <div class="card">
    <label>2. è¼‰ã›ã‚‹æœ¬ã®é‡ã• (kg)</label>
    <input type="range" id="weightRange" min="1" max="50" value="5">
    <div id="weightValue" style="text-align: center; font-weight: bold;">5 kg</div>
  </div>

  <div class="card">
    <label>è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
    <div id="judgeBox">ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€æ£šæ¿ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>
    <div class="legend">
      <span>å®‰å…¨</span><div class="bar"></div><span>å±é™º</span>
    </div>
  </div>

  <button class="secondary" onclick="location.reload()">ã‚„ã‚Šç›´ã™</button>
  
  <p style="font-size: 11px; color: #777; margin-top: 20px;">
    â€»ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´æ‰€ã«é‡ã•ãŒã‹ã‹ã£ãŸæ™‚ã®ã€ŒãŸã‚ã¿ã€ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚èµ¤ã„å ´æ‰€ã»ã©è² æ‹…ãŒå¤§ãã„ã§ã™ã€‚
  </p>
</div>

<div id="canvas-container">
  <div id="view"></div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';

let scene, camera, renderer, controls, mesh;
let originalVertices = []; // å…ƒã®å½¢ã‚’ä¿å­˜

const view = document.getElementById('view');
const weightRange = document.getElementById('weightRange');
const weightValue = document.getElementById('weightValue');
const judgeBox = document.getElementById('judgeBox');

// åˆæœŸåŒ–
function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 3000);
  camera.position.set(200, 150, 200);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth - 350, window.innerHeight);
  view.appendChild(renderer.domElement);

  controls = new OrbitControls(camera, renderer.domElement);
  
  const light1 = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
  scene.add(light1);
  const light2 = new THREE.DirectionalLight(0xffffff, 1);
  light2.position.set(100, 100, 100);
  scene.add(light2);

  animate();
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

// STLèª­ã¿è¾¼ã¿
document.getElementById('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    const loader = new STLLoader();
    const geometry = loader.parse(event.target.result);
    setupMesh(geometry);
  };
  reader.readAsArrayBuffer(file);
});

function setupMesh(geometry) {
  if (mesh) scene.remove(mesh);

  geometry.center();
  geometry.computeVertexNormals();

  // å…ƒã®é ‚ç‚¹æƒ…å ±ã‚’ä¿å­˜ï¼ˆãŸã‚ã¿è¨ˆç®—ç”¨ï¼‰
  const pos = geometry.attributes.position;
  originalVertices = new Float32Array(pos.array);

  // åˆæœŸè‰²ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
  const colors = new Float32Array(pos.count * 3);
  for(let i=0; i<pos.count*3; i++) colors[i] = 0.5;
  geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

  const material = new THREE.MeshStandardMaterial({ 
    vertexColors: true, 
    flatShading: false,
    roughness: 0.5 
  });
  
  mesh = new THREE.Mesh(geometry, material);
  
  // å¤§ãã•èª¿æ•´
  geometry.computeBoundingBox();
  const size = geometry.boundingBox.getSize(new THREE.Vector3());
  const maxDim = Math.max(size.x, size.y, size.z);
  const scale = 150 / maxDim;
  mesh.scale.setScalar(scale);

  scene.add(mesh);
  
  // ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’ãƒ¢ãƒ‡ãƒ«ã«åˆã‚ã›ã‚‹
  camera.position.set(150, 100, 150);
  controls.target.set(0, 0, 0);
}

// è·é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
window.addEventListener('mousedown', (event) => {
  if (!mesh) return;

  const rect = renderer.domElement.getBoundingClientRect();
  const mouse = new THREE.Vector2(
    ((event.clientX - rect.left) / rect.width) * 2 - 1,
    -((event.clientY - rect.top) / rect.height) * 2 + 1
  );

  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObject(mesh);

  if (intersects.length > 0) {
    simulate(intersects[0].point);
  }
});

function simulate(hitPoint) {
  const geo = mesh.geometry;
  const pos = geo.attributes.position;
  const colors = geo.attributes.color;
  const weight = parseFloat(weightRange.value);
  
  // å½±éŸ¿ç¯„å›²ï¼ˆä¸­å­¦ç”Ÿã®ä½œã£ãŸãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ï¼‰
  const radius = 40; 
  const strength = weight / 10; // ãŸã‚ã¿ã®å¼·ã•

  for (let i = 0; i < pos.count; i++) {
    const idx = i * 3;
    // ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã«å¤‰æ›ã—ã¦è·é›¢åˆ¤å®š
    const v = new THREE.Vector3(originalVertices[idx], originalVertices[idx+1], originalVertices[idx+2]);
    v.applyMatrix4(mesh.matrixWorld);
    
    const dist = v.distanceTo(hitPoint);

    if (dist < radius) {
      const effect = Math.pow(1 - dist / radius, 2);
      
      // 1. è‰²ã®å¤‰åŒ– (é’ -> é»„ -> èµ¤)
      const color = new THREE.Color();
      color.setHSL(0.6 * (1 - effect), 1, 0.5);
      colors.setXYZ(i, color.r, color.g, color.b);

      // 2. ãŸã‚ã¿ã®å¤‰åŒ– (Yè»¸ã‚’å°‘ã—ä¸‹ã’ã‚‹)
      pos.setY(i, originalVertices[idx+1] - (effect * strength));
    } else {
      colors.setXYZ(i, 0.2, 0.2, 0.8); // ç¯„å›²å¤–ã¯é’
      pos.setY(i, originalVertices[idx+1]); // å…ƒã«æˆ»ã™
    }
  }

  pos.needsUpdate = true;
  colors.needsUpdate = true;

  // åˆ¤å®šã‚³ãƒ¡ãƒ³ãƒˆ
  if (weight > 30) {
    judgeBox.innerHTML = `åˆ¤å®šï¼š<span class="status-ng">å±é™º</span><br>é‡ã™ãã¾ã™ï¼æ¿ãŒæŠ˜ã‚Œã‚‹ã‹ã€æ¥åˆéƒ¨ãŒå£Šã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`;
  } else if (weight > 15) {
    judgeBox.innerHTML = `åˆ¤å®šï¼š<span class="status-ng">æ³¨æ„</span><br>å°‘ã—ã—ãªã£ã¦ã„ã¾ã™ã€‚çœŸã‚“ä¸­ã«ã€Œæ–¹ç«‹ï¼ˆã»ã†ã ã¦ï¼‰ã€ã‚’å…¥ã‚Œã‚‹ã¨å®‰å¿ƒã§ã™ã€‚`;
  } else {
    judgeBox.innerHTML = `åˆ¤å®šï¼š<span class="status-ok">å®‰å…¨</span><br>ã“ã®é‡ã•ãªã‚‰å¤§ä¸ˆå¤«ãã†ã§ã™ã€‚`;
  }
}

weightRange.addEventListener('input', () => {
  weightValue.innerText = weightRange.value + " kg";
});

window.addEventListener('resize', () => {
  camera.aspect = (window.innerWidth - 350) / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth - 350, window.innerHeight);
});

init();
</script>
</body>
</html>
