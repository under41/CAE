<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœ¨æ ãªã‚“ã¡ã‚ƒã£ã¦CAEï¼ˆæ”¹è‰¯ç‰ˆï¼‰</title>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <style>
    :root{
      --bg:#0b1020; --panel:#111a33; --card:#162146;
      --text:#e9eefc; --muted:#aab6dd;
      --bad:#ff4d4d; --good:#4dffb5; --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #18224a 0%, var(--bg) 60%);
      color:var(--text);
    }
    header{
      padding:14px 16px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background: rgba(10,14,30,0.6);
      backdrop-filter: blur(10px);
      position:sticky; top:0; z-index:10;
    }
    header .badge{
      padding:4px 10px;
      border:1px solid rgba(255,255,255,0.15);
      border-radius:999px;
      font-size:12px; color:var(--muted);
    }
    header h1{ margin:0; font-size:16px; font-weight:700; letter-spacing:0.2px; }

    .wrap{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      padding:14px;
      height: calc(100vh - 54px);
    }
    .panel{
      background: linear-gradient(180deg, rgba(17,26,51,0.95), rgba(10,14,30,0.95));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:18px;
      padding:12px;
      overflow:auto;
    }
    .panel h2{ margin:10px 8px 8px; font-size:14px; color:#dbe3ff; }
    .note{
      font-size:11px; color:rgba(233,238,252,0.72);
      margin:6px 8px 10px; line-height:1.5;
      background: rgba(122,162,255,0.1); padding:8px; border-radius:10px;
    }
    .card{
      background: rgba(22,33,70,0.75);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      padding:10px;
      margin:8px 6px;
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="number"], select, input[type="text"]{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(10,14,30,0.55);
      color:var(--text);
      outline:none;
    }
    input[type="range"]{ width:100%; }
    .hint{ font-size:11px; color:rgba(233,238,252,0.6); line-height:1.35; margin-top:6px; }
    .btns{ display:flex; gap:10px; margin:10px 6px 6px; }
    button{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(122,162,255,0.18);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
    }
    button:hover{ background: rgba(122,162,255,0.28); }
    button.secondary{ background: rgba(255,255,255,0.08); }

    .result{
      margin:8px 6px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(10,14,30,0.55);
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      font-size:13px;
      margin:4px 0;
    }
    .kv .k{ color:var(--muted); }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }
    .pill.good{ border-color: rgba(77,255,181,0.35); color: var(--good); }
    .pill.bad{ border-color: rgba(255,77,77,0.45); color: var(--bad); }
    .pill.info{ border-color: rgba(122,162,255,0.35); color: var(--accent); }

    .view{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
      background: #070b16;
      height: 100%;
    }
    #canvas{ width:100%; height:100%; display:block; }
    .legend{
      position:absolute; left:12px; bottom:12px;
      background: rgba(10,14,30,0.72);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:10px 10px;
      min-width: 240px;
      backdrop-filter: blur(10px);
    }
    .legend .bar{
      height:12px;
      border-radius:999px;
      background: linear-gradient(90deg, #2b5bff 0%, #ff2b2b 100%);
      border:1px solid rgba(255,255,255,0.12);
      margin:6px 0 4px;
    }
    .legend .small{
      display:flex; justify-content:space-between;
      font-size:11px; color:rgba(233,238,252,0.78);
    }
    .toast{
      position:absolute; top:12px; left:12px;
      background: rgba(10,14,30,0.72);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:10px 12px;
      max-width: 760px;
      font-size:12px;
      color:rgba(233,238,252,0.88);
      backdrop-filter: blur(10px);
      z-index: 5;
      line-height:1.45;
    }
    hr.sep{ border:none; border-top:1px solid rgba(255,255,255,0.08); margin:10px 0; }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; height:auto; }
      .view{ height: 60vh; }
    }
  </style>
</head>
<body>
  <header>
    <span class="badge">æœ¨æå°‚ç”¨</span>
    <h1>æœ¨æãªã‚“ã¡ã‚ƒã£ã¦CAEï¼ˆæ”¹è‰¯ç‰ˆï¼‰</h1>
    <span class="badge">æ¢ã®æ›²ã’è¿‘ä¼¼è§£æ</span>
  </header>

  <div class="wrap">
    <aside class="panel">
      <div class="note">
        <strong>ğŸ’¡ 10mmã®æ¿ãŒé’ããªã‚‹æ–¹ã¸ï¼š</strong><br/>
        æ¿ã®å››éš…ã«ã—ã‹ç‚¹ãŒãªã„STLã ã¨çœŸã‚“ä¸­ã®è‰²ãŒå¡—ã‚Œã¾ã›ã‚“ã€‚CADå´ã§ã€Œãƒ¡ãƒƒã‚·ãƒ¥ã‚’ç´°ã‹ãåˆ†å‰²ã€ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
      </div>

      <h2>â‘  STLã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="card">
        <label>STLãƒ•ã‚¡ã‚¤ãƒ«</label>
        <input id="stlFile" type="file" accept=".stl" />
        <div class="row" style="margin-top:10px;">
          <div>
            <label>STLã®å˜ä½</label>
            <select id="unit">
              <option value="0.001" selected>mmï¼ˆã‚ˆãã‚ã‚‹ï¼‰â†’ m</option>
              <option value="0.01">cm â†’ m</option>
              <option value="1">m â†’ m</option>
            </select>
          </div>
          <div>
            <label>é•·ã„æ–¹å‘ï¼ˆæ¢ã®è»¸ï¼‰</label>
            <select id="axis">
              <option value="auto" selected>è‡ªå‹•åˆ¤å®š</option>
              <option value="x">Xè»¸</option>
              <option value="y">Yè»¸</option>
              <option value="z">Zè»¸</option>
            </select>
          </div>
        </div>
      </div>

      <h2>â‘¡ ææ–™ï¼ˆæœ¨æï¼‰</h2>
      <div class="card">
        <div class="row">
          <div>
            <label>æ›²ã’è¨±å®¹å¿œåŠ›ï¼ˆMPaï¼‰</label>
            <input id="allowBendMPa" type="number" value="20" min="1" step="1" />
          </div>
          <div>
            <label>ãƒ¤ãƒ³ã‚°ç‡Eï¼ˆGPaï¼‰</label>
            <input id="E_GPa" type="number" value="10" min="1" step="0.5" />
          </div>
        </div>
      </div>

      <h2>â‘¢ è·é‡ï¼ˆé‡ã•ï¼‰</h2>
      <div class="card">
        <label>è·é‡ã®ç¨®é¡</label>
        <select id="loadType">
          <option value="point" selected>ä¸€ç‚¹ã«ã®ã›ã‚‹ï¼ˆç‚¹è·é‡ï¼‰</option>
          <option value="udl">å…¨ä½“ã«ã®ã›ã‚‹ï¼ˆç­‰åˆ†å¸ƒè·é‡ï¼‰</option>
        </select>
        <div class="row" style="margin-top:10px;">
          <div>
            <label id="loadMagLabel">é‡ã• Pï¼ˆNï¼‰</label>
            <input id="loadMag" type="number" value="100" min="0" step="1" />
          </div>
          <div id="loadPosWrap">
            <label>ä½ç½®ï¼ˆå·¦â†’å³ï¼‰</label>
            <input id="loadPos" type="range" min="0" max="100" value="50" />
            <div class="hint"><span id="loadPosTxt">50</span>%</div>
          </div>
        </div>
      </div>

      <h2>â‘£ æ¥åˆï¼ˆé‡˜ï¼‰ã®å¼·åº¦</h2>
      <div class="card">
        <div class="row">
          <div>
            <label>å·¦ï¼šé‡˜ã®æœ¬æ•°</label>
            <input id="nNailsL" type="number" value="2" min="1" />
          </div>
          <div>
            <label>å³ï¼šé‡˜ã®æœ¬æ•°</label>
            <input id="nNailsR" type="number" value="2" min="1" />
          </div>
        </div>
        <div style="margin-top:10px;">
          <label>é‡˜1æœ¬ã®è¨±å®¹å¼·åº¦ï¼ˆNï¼‰</label>
          <input id="allowNailN" type="number" value="80" min="1" />
        </div>
      </div>

      <div class="btns">
        <button id="analyzeBtn">è§£æã™ã‚‹</button>
        <button id="resetBtn" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="result" id="resultBox">
        <div class="kv"><div class="k">çŠ¶æ…‹</div><div class="v"><span class="pill">æœªè§£æ</span></div></div>
        <div class="kv"><div class="k">æ¢ã®é•·ã• L</div><div class="v">â€”</div></div>
        <div class="kv"><div class="k">æ–­é¢ï¼ˆå¹…b Ã— é«˜ã•hï¼‰</div><div class="v">â€”</div></div>
        <div class="kv"><div class="k">æœ€å¤§å¿œåŠ›ï¼ˆMPaï¼‰</div><div class="v">â€”</div></div>
        <div class="kv"><div class="k">å®‰å…¨ç‡</div><div class="v">â€”</div></div>
        <hr class="sep">
        <div class="kv"><div class="k">æ¥åˆåˆ¤å®š</div><div class="v">â€”</div></div>
      </div>
    </aside>

    <main class="view">
      <div class="toast">
        æ“ä½œï¼šå·¦ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢ / å³ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• / ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆãƒã‚¤ãƒ«ãƒ‰ï¼‰<br/>
        <span id="live">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</span>
      </div>
      <canvas id="canvas"></canvas>
      <div class="legend">
        <div style="font-size:12px;color:rgba(233,238,252,0.85);">è‰²ï¼šãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆè² è·ï¼ˆé’â†’èµ¤ï¼‰</div>
        <div class="bar"></div>
        <div class="small"><span>è² è· å°</span><span>è² è· æœ€å¤§</span></div>
        <div class="small" style="margin-top:6px;">
          <span>è¨ˆç®—æœ€å¤§å¿œåŠ›:</span>
          <span id="legendMax">â€” MPa</span>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { STLLoader } from "three/addons/loaders/STLLoader.js";

    const el = (id)=>document.getElementById(id);
    const canvas = el("canvas");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x070b16, 5, 50);

    const camera = new THREE.PerspectiveCamera(50, 1, 0.01, 2000);
    camera.position.set(3, 2, 4);

    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.enableZoom = false; // è‡ªå‰ã‚ºãƒ¼ãƒ ã‚’ä½¿ã†ãŸã‚

    scene.add(new THREE.HemisphereLight(0xbfd0ff, 0x111122, 1.2));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
    dirLight.position.set(5, 10, 5);
    scene.add(dirLight);

    const grid = new THREE.GridHelper(20, 20, 0x334477, 0x223355);
    grid.position.y = -0.5;
    scene.add(grid);

    let mesh = null;

    // è‡ªå‰ãƒã‚¤ãƒ«ãƒ‰ã‚ºãƒ¼ãƒ 
    canvas.addEventListener("wheel", (e)=>{
      e.preventDefault();
      const dy = Math.max(-120, Math.min(120, e.deltaY));
      const scale = Math.exp(dy * 0.0004);
      const v = new THREE.Vector3().subVectors(camera.position, controls.target);
      v.multiplyScalar(scale);
      camera.position.copy(controls.target).add(v);
    }, { passive:false });

    function animate(){
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    function resize(){
      const rect = canvas.getBoundingClientRect();
      renderer.setSize(rect.width, rect.height, false);
      camera.aspect = rect.width / rect.height;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);
    resize();
    el("live").textContent = "ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†";

    // è»¸åˆ¤å®šï¼ˆä¸€ç•ªé•·ã„è¾ºã‚’æ¢ã®é•·ã•æ–¹å‘ã¨ã™ã‚‹ï¼‰
    function chooseAutoAxis(size){
      let axis = "x";
      if(size.y > size.x && size.y > size.z) axis = "y";
      if(size.z > size.x && size.z > size.y) axis = "z";
      return axis;
    }

    // è§£æãƒ­ã‚¸ãƒƒã‚¯
    el("analyzeBtn").addEventListener("click", ()=>{
      if(!mesh){
        alert("ã¾ãšSTLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„");
        return;
      }

      mesh.geometry.computeBoundingBox();
      const bbox = mesh.geometry.boundingBox;
      const size = new THREE.Vector3(); bbox.getSize(size);

      // 1. æ¢ã®é•·ã•æ–¹å‘ã‚’æ±ºã‚ã‚‹
      let axis = el("axis").value;
      if(axis === "auto") axis = chooseAutoAxis(size);

      // 2. æ–­é¢å¯¸æ³•ã‚’æ±ºã‚ã‚‹ï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
      // æ®‹ã‚Šã®2è¾ºã®ã†ã¡ã€å°ã•ã„æ–¹ã‚’ã€Œé«˜ã•hï¼ˆæ¿ã®åšã¿ï¼‰ã€ã€å¤§ãã„æ–¹ã‚’ã€Œå¹…bã€ã¨ã™ã‚‹
      const otherAxes = ["x","y","z"].filter(a => a !== axis);
      let dim1 = size[otherAxes[0]], dim2 = size[otherAxes[1]];
      let h = Math.min(dim1, dim2);
      let b = Math.max(dim1, dim2);
      let L = size[axis];

      // 3. è·é‡è¨ˆç®—
      const P = Number(el("loadMag").value);
      const isPoint = el("loadType").value === "point";
      let maxM = 0;
      
      if(isPoint){
        const a = L * (Number(el("loadPos").value)/100);
        maxM = (P * a * (L - a)) / L; // å˜ç´”æ”¯æŒæ¢ã®æœ€å¤§ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ
      } else {
        maxM = (P * L * L) / 8; // ç­‰åˆ†å¸ƒè·é‡(Pã‚’N/mã¨ã—ãŸå ´åˆ)ã®æœ€å¤§ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆ
      }

      // 4. å¿œåŠ›è¨ˆç®— Ïƒ = M / (I/y) = M / Z
      const I = (b * Math.pow(h, 3)) / 12;
      const Z = I / (h / 2);
      const maxSigmaPa = maxM / Z;
      const maxMPa = maxSigmaPa / 1e6;

      // 5. è‰²å¡—ã‚Šï¼ˆé ‚ç‚¹ã”ã¨ã®ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã‚’è¨ˆç®—ï¼‰
      const pos = mesh.geometry.getAttribute("position");
      const colors = new Float32Array(pos.count * 3);
      const minVal = bbox.min[axis];

      // é ‚ç‚¹æ•°ãŒæ¥µç«¯ã«å°‘ãªã„å ´åˆã®è­¦å‘Š
      if(pos.count < 100) {
        console.warn("é ‚ç‚¹æ•°ãŒå°‘ãªã„ãŸã‚ã€ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
      }

      for(let i=0; i<pos.count; i++){
        const xLocal = pos.getComponent(i, ["x","y","z"].indexOf(axis)) - minVal;
        let M_local = 0;
        if(isPoint){
          const a = L * (Number(el("loadPos").value)/100);
          const R1 = P * (L - a) / L;
          M_local = (xLocal < a) ? (R1 * xLocal) : (R1 * xLocal - P * (xLocal - a));
        } else {
          M_local = (P * L / 2) * xLocal - (P * xLocal * xLocal / 2);
        }
        
        const t = Math.abs(M_local) / (maxM || 1); // 0ã€œ1ã«æ­£è¦åŒ–
        colors[i*3+0] = t;       // R
        colors[i*3+1] = 0.2;     // G
        colors[i*3+2] = 1.0 - t; // B
      }

      mesh.geometry.setAttribute("color", new THREE.BufferAttribute(colors, 3));
      mesh.material.vertexColors = true;
      mesh.material.needsUpdate = true;

      // çµæœè¡¨ç¤º
      const allowPa = Number(el("allowBendMPa").value) * 1e6;
      const sf = allowPa / maxSigmaPa;
      
      el("resultBox").querySelector(".pill").textContent = "è§£æå®Œäº†";
      el("resultBox").querySelector(".pill").className = (sf >= 1) ? "pill good" : "pill bad";
      
      const rows = el("resultBox").querySelectorAll(".v");
      rows[1].textContent = `${L.toFixed(3)} m (è»¸: ${axis.toUpperCase()})`;
      rows[2].textContent = `${b.toFixed(3)} m Ã— ${h.toFixed(3)} m`;
      rows[3].textContent = `${maxMPa.toFixed(3)} MPa`;
      rows[4].textContent = sf.toFixed(2);
      el("legendMax").textContent = `${maxMPa.toFixed(3)} MPa`;
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    el("stlFile").addEventListener("change", async (ev)=>{
      const file = ev.target.files[0];
      if(!file) return;
      const loader = new STLLoader();
      const arrayBuffer = await file.arrayBuffer();
      const geometry = loader.parse(arrayBuffer);
      
      const scale = Number(el("unit").value);
      geometry.scale(scale, scale, scale);
      geometry.computeVertexNormals();
      geometry.center();

      if(mesh) scene.remove(mesh);
      mesh = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ color: 0x9fb2ff, roughness:0.8 }));
      scene.add(mesh);

      // ã‚«ãƒ¡ãƒ©ã‚’åˆã‚ã›ã‚‹
      geometry.computeBoundingSphere();
      const r = geometry.boundingSphere.radius;
      camera.position.set(r*2, r*2, r*2);
      controls.target.set(0,0,0);
    });

    // ãƒªã‚»ãƒƒãƒˆ
    el("resetBtn").addEventListener("click", ()=>{
      location.reload();
    });

    el("loadPos").addEventListener("input", (e)=> el("loadPosTxt").textContent = e.target.value);
  </script>
</body>
</html>
